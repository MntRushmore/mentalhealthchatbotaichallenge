services:
  - type: web
    name: calmtext-backend
    env: node
    region: oregon
    plan: free
    buildCommand: npm install
    startCommand: npm start
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: calmtext-redis
          property: connectionString
      - key: LOG_LEVEL
        value: info
      - key: RATE_LIMIT_HOUR
        value: 10
      - key: RATE_LIMIT_DAY
        value: 50

  - type: redis
    name: calmtext-redis
    region: oregon
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

# ========================================
# FILE: vercel.json
# For Vercel deployment (serverless)
# ========================================
{
  "version": 2,
  "builds": [
    {
      "src": "src/server.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/health",
      "dest": "src/server.js"
    },
    {
      "src": "/sms/webhook",
      "dest": "src/server.js",
      "methods": ["POST"]
    },
    {
      "src": "/(.*)",
      "dest": "src/server.js"
    }
  ],
  "env": {
    "NODE_ENV": "production",
    "TWILIO_ACCOUNT_SID": "@twilio_account_sid",
    "TWILIO_AUTH_TOKEN": "@twilio_auth_token",
    "TWILIO_PHONE_NUMBER": "@twilio_phone_number",
    "ANTHROPIC_API_KEY": "@anthropic_api_key",
    "REDIS_URL": "@redis_url"
  }
}

